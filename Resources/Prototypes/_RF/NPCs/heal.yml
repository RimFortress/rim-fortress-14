- type: htnCompound
  id: HealCompound
  branches:
    # Turns out stopping the bleeding is not a very
    # important part of the healing and it goes away on its own,
    # so I think we can remove it

    # Stop bleeding
    #- preconditions:
    #    - !type:KeyExistsPrecondition
    #      key: Target
    #    - !type:BleedingPrecondition
    #      targetKey: Target
    #  tasks:
    #    - !type:HTNCompoundTask
    #      task: StopBleedingCompound

    # Restore blood level
    - preconditions:
        - !type:KeyExistsPrecondition
          key: Target
        - !type:BloodLevelPrecondition
          targetKey: Target
          lessThan: 1.0
      tasks:
        - !type:HTNCompoundTask
          task: RestoreBloodLevelCompound

    # Heal
    - preconditions:
        - !type:KeyExistsPrecondition
          key: Target
      tasks:
        - !type:HTNCompoundTask
          task: BaseHealCompound

- type: htnCompound
  id: BaseHealCompound
  branches:
    # Finding the right medicine
    - preconditions:
        - !type:KeyNotExistsPrecondition
          key: PickUpTarget
        - !type:HasComponentPrecondition
          components:
            - type: ActiveDoAfter
          invert: true
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:GetEntityDamageOperator
            targetKey: Target
        - !type:HTNPrimitiveTask
          operator: !type:UtilityOperator
            proto: TargetHeal
            key: PickUpTarget

    # Pick up finded item
    - preconditions:
        - !type:KeyExistsPrecondition
          key: PickUpTarget
        - !type:ActiveHandEntityIsPrecondition
          targetKey: PickUpTarget
          invert: true
      tasks:
        - !type:HTNCompoundTask
          task: PickUpCompound

    # Go to the target for healing if it's far away
    - preconditions:
        - !type:KeyExistsPrecondition
          key: Target
        - !type:TargetNotInRangePrecondition
          targetKey: Target
          rangeKey: MeleeRange
      tasks:
        - !type:HTNCompoundTask
          task: MoveToEntityCompound

    # And finally, healing the target
    - preconditions:
        - !type:KeysExistsPrecondition
            keys:
              - Target
              - PickUpTarget
        - !type:TargetInRangePrecondition
          targetKey: Target
          rangeKey: InteractRange
        - !type:HasComponentPrecondition
          components:
            - type: ActiveDoAfter
          invert: true
        - !type:ActiveHandEntityIsPrecondition
          targetKey: PickUpTarget
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:InteractWithOperator
            targetKey: Target
        - !type:HTNPrimitiveTask
          operator: !type:RemoveKeyOperator
            key: PickUpTarget


- type: htnCompound
  id: StopBleedingCompound
  branches:
    - preconditions:
        - !type:KeyNotExistsPrecondition
          key: PickUpTarget
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:UtilityOperator
            proto: HeatMelee
            key: PickUpTarget

    # Pick up finded item
    - preconditions:
        - !type:KeyExistsPrecondition
          key: PickUpTarget
        - !type:ActiveHandEntityIsPrecondition
          targetKey: PickUpTarget
          invert: true
      tasks:
        - !type:HTNCompoundTask
          task: PickUpCompound

    # Go to the target for healing if it's far away
    - preconditions:
        - !type:KeyExistsPrecondition
          key: Target
        - !type:TargetNotInRangePrecondition
          targetKey: Target
          rangeKey: MeleeRange
      tasks:
        - !type:HTNCompoundTask
          task: MoveToEntityCompound

    - preconditions:
        - !type:KeysExistsPrecondition
            keys:
              - Target
              - PickUpTarget
        - !type:TargetInRangePrecondition
          targetKey: Target
          rangeKey: MeleeRange
        - !type:ActiveHandEntityIsPrecondition
          targetKey: PickUpTarget
        - !type:BleedingPrecondition
          targetKey: Target
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:MeleeOperator
            targetKey: Target
        - !type:HTNPrimitiveTask
          operator: !type:RemoveKeyOperator
            key: PickUpTarget


- type: htnCompound
  id: RestoreBloodLevelCompound
  branches:
    - preconditions:
        - !type:KeyNotExistsPrecondition
          key: PickUpTarget
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:UtilityOperator
            proto: BloodLevelHeal
            key: PickUpTarget

    # Pick up finded item
    - preconditions:
        - !type:KeyExistsPrecondition
          key: PickUpTarget
        - !type:ActiveHandEntityIsPrecondition
          targetKey: PickUpTarget
          invert: true
      tasks:
        - !type:HTNCompoundTask
          task: PickUpCompound

    # Go to the target for healing if it's far away
    - preconditions:
        - !type:KeyExistsPrecondition
          key: Target
        - !type:TargetNotInRangePrecondition
          targetKey: Target
          rangeKey: MeleeRange
      tasks:
        - !type:HTNCompoundTask
          task: MoveToEntityCompound

    - preconditions:
        - !type:KeysExistsPrecondition
            keys:
              - Target
              - PickUpTarget
        - !type:TargetInRangePrecondition
          targetKey: Target
          rangeKey: MeleeRange
        - !type:ActiveHandEntityIsPrecondition
          targetKey: PickUpTarget
        - !type:BloodLevelPrecondition
          targetKey: Target
          lessThan: 1.0
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:InteractWithOperator
            targetKey: Target
        - !type:HTNPrimitiveTask
          operator: !type:RemoveKeyOperator
            key: PickUpTarget
