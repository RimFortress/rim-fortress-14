- type: htnCompound
  id: MoveToCompound
  branches:
    # Unbuckle
    - preconditions:
        - !type:BuckledPrecondition
          isBuckled: true
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:UnbuckleOperator

    # Unpull
    - preconditions:
        - !type:PulledPrecondition
          isPulled: true
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:UnPullOperator

    # Leave the container
    - preconditions:
        - !type:InContainerPrecondition
          isInContainer: true
      tasks:
        - !type:HTNCompoundTask
          task: EscapeCompound

    # Move to target
    - preconditions:
        - !type:KeyExistsPrecondition
          key: TargetCoordinates
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:SetFloatOperator
            targetKey: MoveToCloseRange
            amount: 0.30
        - !type:HTNPrimitiveTask
          operator: !type:MoveToOperator
            pathfindInPlanning: true
            targetKey: TargetCoordinates
            rangeKey: MoveToCloseRange
            removeKeyOnFinish: false


- type: htnCompound
  id: AttackTargetCompound
  branches:
    # Unbuckle
    - preconditions:
        - !type:BuckledPrecondition
          isBuckled: true
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:UnbuckleOperator

    # Unpull
    - preconditions:
        - !type:PulledPrecondition
          isPulled: true
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:UnPullOperator

    # Leave the container
    - preconditions:
        - !type:InContainerPrecondition
          isInContainer: true
      tasks:
        - !type:HTNCompoundTask
          task: EscapeCompound

    - preconditions:
        - !type:ActiveHandComponentPrecondition
          components:
            - type: Wieldable
            - type: GunRequiresWield
        - !type:WieldedPrecondition
          invert: true
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:WieldOperator

    # Insert the cartridge into the chamber, if necessary
    - preconditions:
        - !type:ActiveHandComponentPrecondition
          components:
            - type: ChamberMagazineAmmoProvider
        - !type:BoltClosedPrecondition
          invert: true
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:SwitchBoltClosedOperator

    # Drop the gun NOW!!!
    - preconditions:
        - !type:ActiveHandComponentPrecondition
          components:
            - type: Gun
        - !type:ActiveHandEntityPrecondition
        - !type:GunAmmoPrecondition
          maxPercent: 0.001
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:DropOperator

    # Gun
    - preconditions:
        - !type:ActiveHandComponentPrecondition
          components:
            - type: Gun
        - !type:GunAmmoPrecondition
          minPercent: 0.001
        - !type:KeyExistsPrecondition
          key: Target
        - !type:KeyExistsPrecondition
          key: TargetCoordinates
      tasks:
        # Move to the target
        - !type:HTNPrimitiveTask
          operator: !type:MoveToOperator
            pathfindInPlanning: true
            removeKeyOnFinish: false
            stopOnLineOfSight: true
            targetKey: TargetCoordinates
            rangeKey: MeleeRange
        - !type:HTNPrimitiveTask
          operator: !type:JukeOperator
            jukeType: Away
        # Attack with a gun
        - !type:HTNPrimitiveTask
          operator: !type:GunOperator
            targetKey: Target
            opaqueKey: true

    # Melee
    - preconditions:
        - !type:ActiveHandComponentPrecondition
          components:
            - type: Gun
          invert: true
        - !type:KeyExistsPrecondition
          key: Target
        - !type:KeyExistsPrecondition
          key: TargetCoordinates
      tasks:
        # Else go to the target at melee distance
        - !type:HTNPrimitiveTask
          operator: !type:MoveToOperator
            pathfindInPlanning: true
            removeKeyOnFinish: false
            targetKey: TargetCoordinates
            rangeKey: MeleeRange
        # Attack in close combat if no gun is available
        - !type:HTNPrimitiveTask
          preconditions:
            - !type:KeyExistsPrecondition
              key: Target
            - !type:TargetInRangePrecondition
              targetKey: Target
              rangeKey: MeleeRange
          operator: !type:MeleeOperator
            targetKey: Target


- type: htnCompound
  id: PickUpCompound
  branches:
    # Unbuckle
    - preconditions:
        - !type:BuckledPrecondition
          isBuckled: true
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:UnbuckleOperator

    # Unpull
    - preconditions:
        - !type:PulledPrecondition
          isPulled: true
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:UnPullOperator

    # Leave the container
    - preconditions:
        - !type:InContainerPrecondition
          isInContainer: true
      tasks:
        - !type:HTNCompoundTask
          task: EscapeCompound

    # Drop item in hands
    - preconditions:
        - !type:ActiveHandEntityPrecondition
        - !type:KeyExistsPrecondition
          key: Target
        - !type:ActiveHandEntityIsPrecondition
          targetKey: Target
          invert: true
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:DropOperator

    # Move to target and pick up
    - preconditions:
        - !type:KeyExistsPrecondition
          key: Target
        - !type:KeyExistsPrecondition
          key: TargetCoordinates
        - !type:ActiveHandFreePrecondition
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:MoveToOperator
            pathfindInPlanning: true
            targetKey: TargetCoordinates
            rangeKey: InteractRange
            removeKeyOnFinish: false
        - !type:HTNPrimitiveTask
          preconditions:
            - !type:TargetInRangePrecondition
              targetKey: Target
              rangeKey: InteractRange
          operator: !type:InteractWithOperator
            targetKey: Target
