- type: htnCompound
  id: MoveToCompound
  branches:
    # Unbuckle
    - preconditions:
        - !type:BuckledPrecondition
          isBuckled: true
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:UnbuckleOperator

    # Unpull
    - preconditions:
        - !type:PulledPrecondition
          isPulled: true
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:UnPullOperator

    # Leave the container
    - preconditions:
        - !type:InContainerPrecondition
          isInContainer: true
      tasks:
        - !type:HTNCompoundTask
          task: EscapeCompound

    # Move to target
    - preconditions:
        - !type:KeyExistsPrecondition
          key: MoveToTargetCoordinates
        - !type:KeyExistsPrecondition
          key: MoveToCloseRange
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:MoveToOperator
            pathfindInPlanning: true
            targetKey: MoveToTargetCoordinates
            rangeKey: MoveToCloseRange
            removeKeyOnFinish: false

- type: htnCompound
  id: AttackTargetCompound
  branches:
    # Unbuckle
    - preconditions:
        - !type:BuckledPrecondition
          isBuckled: true
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:UnbuckleOperator

    # Unpull
    - preconditions:
        - !type:PulledPrecondition
          isPulled: true
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:UnPullOperator

    # Leave the container
    - preconditions:
        - !type:InContainerPrecondition
          isInContainer: true
      tasks:
        - !type:HTNCompoundTask
          task: EscapeCompound

    # Gun
    - preconditions:
        - !type:ActiveHandComponentPrecondition
          components:
            - type: Gun
        - !type:GunAmmoPrecondition
          minPercent: 0.001
        - !type:KeyExistsPrecondition
          key: AttackTarget
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:MoveToOperator
            pathfindInPlanning: true
            removeKeyOnFinish: false
            stopOnLineOfSight: true
            targetKey: AttackTargetCoordinates
            rangeKey: MeleeRange
        - !type:HTNPrimitiveTask
          operator: !type:JukeOperator
            jukeType: AdjacentTile
        # Attack with a gun
        - !type:HTNPrimitiveTask
          operator: !type:GunOperator
            targetKey: AttackTarget
        - !type:HTNPrimitiveTask
          preconditions:
            - !type:ActiveHandEntityPrecondition
            - !type:GunAmmoPrecondition
              maxPercent: 0.001
          operator: !type:DropOperator
    # Melee
    - preconditions:
        - !type:ActiveHandComponentPrecondition
          components:
            - type: Gun
          invert: true
        - !type:KeyExistsPrecondition
          key: AttackTarget
        - !type:KeyExistsPrecondition
          key: AttackTargetCoordinates
      tasks:
        # Else go to the target at melee distance
        - !type:HTNPrimitiveTask
          operator: !type:MoveToOperator
            pathfindInPlanning: true
            removeKeyOnFinish: false
            targetKey: AttackTargetCoordinates
            rangeKey: MeleeRange
        # Attack in close combat if no gun is available
        - !type:HTNPrimitiveTask
          preconditions:
            - !type:KeyExistsPrecondition
              key: AttackTarget
            - !type:TargetInRangePrecondition
              targetKey: AttackTarget
              rangeKey: MeleeRange
          operator: !type:MeleeOperator
            targetKey: AttackTarget
